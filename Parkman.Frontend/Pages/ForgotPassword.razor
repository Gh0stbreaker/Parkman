@page "/forgot-password"
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@using Parkman.Shared.Models

<div class="container py-4">
    <h3 class="text-center mb-4 h4">Forgot Password</h3>

    <EditForm EditContext="_editContext" OnValidSubmit="Handle" class="col-md-6 mx-auto card p-4">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="mb-3">
            <label class="form-label">Email</label>
            <InputText @bind-Value="_model.Email" class="form-control" />
            <ValidationMessage For="@(() => _model.Email)" class="text-danger text-sm" />
        </div>
        <button type="submit" class="btn btn-primary w-100" disabled="@isSubmitting">
            @(isSubmitting ? "Sending..." : "Send")
        </button>
    </EditForm>
    @if (message != null)
    {
        <p class="text-center mt-3">@message</p>
    }
</div>

@code {
    private ForgotPasswordRequest _model = new();
    private EditContext _editContext = default!;
    private bool isSubmitting;
    private string? message;

    [Inject] private HttpClient Http { get; set; } = default!;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    private async Task Handle()
    {
        isSubmitting = true;
        message = null;
        var response = await Http.PostAsJsonAsync("api/auth/forgot-password", _model);
        if (response.IsSuccessStatusCode)
        {
            message = "If an account with that email exists, a reset link was sent.";
            _model = new();
            _editContext = new EditContext(_model);
        }
        else
        {
            message = "Request failed.";
        }
        isSubmitting = false;
    }
}
